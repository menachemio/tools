#!/usr/bin/env bash
# Session Manager - YAML-based tmux session management with subsessions
# Usage: session [session-name] [subsession-name] [options]

set -eo pipefail

# Resolve tools root
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TOOLS_DIR="$(dirname "$SCRIPT_DIR")"
LIB_DIR="$TOOLS_DIR/lib"

# Source core functionality
source "$LIB_DIR/session/core.sh"

# Global variables
SUBSESSION_NAME=""
HEADLESS_MODE=false
ACTION=""
INSTALL_TARGET=""

# Help message
show_help() {
    cat << 'EOF'
Session Manager - YAML-based tmux session management

Usage:
  <session-name>                             Start/attach to session
  <session-name> --headless                  Start session in background
  <session-name> <subsession>               Start/attach to subsession
  <session-name> <subsession> --headless    Start subsession in background
  <session-name> stop                        Stop main session (keep subsessions)
  <session-name> <subsession> stop          Stop specific subsession
  <session-name> kill                        Kill all sessions
  <session-name> status                      Show session status
  <session-name> restart                     Restart session
  <session-name> restart <subsession>       Restart subsession

  session install <config.yaml>      Register project as a command

Config lookup order:
  1. ./<session-name>.session.yaml
  2. ./.session.yaml
  3. ~/.config/tools/sessions/<session-name>.yaml

Pane types:
  command   - Run or pre-fill a shell command
  subsession - Attach to a managed subsession
EOF
}

# Install a session config as a named command in ~/.local/bin
install_session_command() {
    local config_file="$1"
    local install_dir="$HOME/.local/bin"

    if [[ ! -f "$config_file" ]]; then
        die "Config file not found: $config_file"
    fi

    # Resolve to absolute path
    local abs_config
    abs_config="$(cd "$(dirname "$config_file")" && pwd)/$(basename "$config_file")"

    # Parse the YAML to get the session name
    source "$LIB_DIR/common/yaml-parser.sh"
    if ! parse_yaml "$abs_config"; then
        die "Failed to parse YAML: $abs_config"
    fi

    local name
    name=$(yaml_get "name")
    if [[ -z "$name" ]]; then
        die "No 'name' field found in $abs_config"
    fi

    mkdir -p "$install_dir"

    local wrapper="$install_dir/$name"
    local session_bin="$TOOLS_DIR/bin/session"

    cat > "$wrapper" << EOF
#!/usr/bin/env bash
# tools-session-wrapper: $name
SESSION_CONFIG_FILE="$abs_config"
export SESSION_CONFIG_FILE
exec "$session_bin" "\$@"
EOF
    chmod +x "$wrapper"

    echo "Installed '$name' -> $wrapper"
    echo "  Config: $abs_config"
    echo "  Usage:  $name [subsession] [--headless|status|stop|kill|restart]"
}

# Parse command line arguments
parse_args() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
            help|--help|-h)
                show_help
                exit 0
                ;;
            --headless)
                HEADLESS_MODE=true
                ;;
            --verbose|-v)
                export VERBOSE=true
                ;;
            install)
                ACTION="install"
                shift
                INSTALL_TARGET="${1:-}"
                return 0
                ;;
            stop|kill|status|restart)
                ACTION="$1"
                ;;
            *)
                # First unknown arg = session name (if not set via CONFIG_FILE env)
                # Second unknown arg = subsession name
                if [[ -z "$SESSION_NAME" && -z "${SESSION_CONFIG_FILE:-}" ]]; then
                    SESSION_NAME="$1"
                elif [[ -z "$SUBSESSION_NAME" ]]; then
                    SUBSESSION_NAME="$1"
                fi
                ;;
        esac
        shift
    done

    if [[ -z "$ACTION" ]]; then
        ACTION="start"
    fi
}

# Main execution
main() {
    parse_args "$@"

    # Handle install command (no config loading needed)
    if [[ "$ACTION" == "install" ]]; then
        if [[ -z "$INSTALL_TARGET" ]]; then
            die "Usage: session install <config.yaml>"
        fi
        install_session_command "$INSTALL_TARGET"
        return 0
    fi

    # Determine config file location
    local config_path=""

    if [[ -n "${SESSION_CONFIG_FILE:-}" ]]; then
        # Config path passed via environment (from installed wrapper command)
        config_path="$SESSION_CONFIG_FILE"
    else
        # Use session name to find config
        [[ -z "$SESSION_NAME" ]] && SESSION_NAME=$(basename "$PWD")

        config_path=$(find_session_config "." "$SESSION_NAME") || {
            die "No config found for '$SESSION_NAME'. Create ${SESSION_NAME}.session.yaml"
        }
    fi

    # Load configuration
    load_session_config "$config_path"

    # Handle subsession commands
    if [[ -n "$SUBSESSION_NAME" && "$ACTION" != "restart" ]]; then
        case "$ACTION" in
            start)
                ensure_subsession "$SUBSESSION_NAME"
                if [[ "$HEADLESS_MODE" == true ]]; then
                    log "Subsession '$SUBSESSION_NAME' started in background"
                else
                    exec tmux attach-session -t "$SUBSESSION_NAME"
                fi
                ;;
            stop)    stop_subsession "$SUBSESSION_NAME" ;;
            status)  echo "Subsession $SUBSESSION_NAME: $(subsession_status "$SUBSESSION_NAME")" ;;
            kill)    stop_subsession "$SUBSESSION_NAME" ;;
            *)       die "Invalid action: $ACTION" ;;
        esac
        return 0
    fi

    # Handle restart with optional subsession target
    if [[ "$ACTION" == "restart" && -n "$SUBSESSION_NAME" ]]; then
        restart_subsession "$SUBSESSION_NAME"
        return 0
    fi

    # Handle session-level commands
    case "$ACTION" in
        start)
            if [[ "$HEADLESS_MODE" == true ]]; then
                start_session "--headless"
            else
                start_session
            fi
            ;;
        stop)     stop_session ;;
        kill)     kill_all_sessions ;;
        status)   show_session_status ;;
        restart)
            stop_session
            sleep 2
            start_session
            ;;
        *)        die "Unknown action: $ACTION" ;;
    esac
}

main "$@"
